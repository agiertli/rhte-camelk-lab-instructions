<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Red Hat Tech Exchange 2023</title>
    <link rel="canonical" href="https://agiertli.github.io/rhte-camelk-lab-instructions/tutorial/index.html/template-tutorial/lab5.html">
    <link rel="prev" href="lab4.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://agiertli.github.io/rhte-camelk-lab-instructions/tutorial/index.html">Red Hat Tech Exchange 2023</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="template-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="01-setup.html">0. Setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab1.html">1. Lab 1 - Local Development</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab2.html">2. Lab 2 - Customizing Kamelets</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab3.html">3. Lab 3 - KameletBinding evolution</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab4.html">4. Lab 4 - Traditional CI/CD</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="lab5.html">5. Lab 5 - GitOps styled Continuous Delivery</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Template Tutorial</a></li>
    <li><a href="lab5.html">5. Lab 5 - GitOps styled Continuous Delivery</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/agiertli/rhte-camelk-lab-instructions/edit/main/documentation/modules/ROOT/pages/lab5.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_lab_5_gitops_styled_continuous_delivery"><a class="anchor" href="#_lab_5_gitops_styled_continuous_delivery"></a>Lab 5 - GitOps styled Continuous Delivery</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_intro"><a class="anchor" href="#_intro"></a>Intro</h3>
<div class="paragraph">
<p>In this lab we are going to deploy our Integrations using GitOps
approach.</p>
</div>
<div class="paragraph">
<p>We will explore helm and ArgoCD integration, sealed secrets and also
promotion process between <code>dev</code> and <code>prod</code> environment.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/gitops.png" alt="GitOps">
</div>
<div class="title">Figure 1. GitOps</div>
</div>
</div>
<div class="sect2">
<h3 id="_tasks"><a class="anchor" href="#_tasks"></a>Tasks</h3>
<div class="paragraph">
<p><strong>1. Create SealedSecrets</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Checkout <code>main</code> branch of your user gitea repository and switch
context to <code>userN-dev</code> openshift project.</p>
</li>
<li>
<p>Cleanup leftovers from the previous lab - edit <code>cleanup.sh</code> and
execute it <code>$ cd labs/lab5     $ ./utils/cleanup.sh</code></p>
</li>
<li>
<p>Generate Sealed secrets through a prepared script.
<code>$ ./utils/create-secrets.sh</code></p>
</li>
<li>
<p>Move the generated yaml files to <code>labs/lab5/secrets/dev</code> folder.</p>
</li>
<li>
<p>Change context to <code>userN-prod</code> openshift project and execute the same
script again. This time, move the generated files to
<code>labs/lab5/secrets/prod</code>.</p>
</li>
<li>
<p>Make sure to delete any generated yaml files from the <code>utils</code> folder.</p>
</li>
<li>
<p>Commit and push your changes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>create-secrets.sh</code> script is using <code>kubeseal</code> cli to communicate
with the SealedSecret controller in order to seal your secrets. The
generated secrets are encrypted and can be safely stored to the git
repository since they can’t be decrypted without the private key, which
is owned by the SealedSecrets controller.</p>
</div>
<div class="paragraph">
<p>Each user has 4 different Argo applications created for them, you can
find more about these:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc get application -n openshift-gitops | grep userN-</pre>
</div>
</div>
<div class="paragraph">
<p>Once you push the sealed secrets to your git repository, ArgoCD will
apply them to the desired namespace and the SealedSecret controller will
turn the SealedSecret into regular openshift secrets, which can be
finally used by our camel-k integrations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Verify everything went well:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get sealedsecret
$ oc get secret &lt;NAME OF THE SECRET&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>2. Create Camel-K objects</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Checkout the <code>dev</code> branch and edit <code>lab5/charts/dev/values.yaml</code> - Add
as many bindings as needed, and don’t forget to adjust names and
destinationNames so they match your group name.</p>
</li>
<li>
<p>Git commit and push your changes to the <code>dev</code> branch. The ArgoCD
application is monitoring <code>dev</code> branch for changes and will apply them
to <code>userN-dev</code> openshift project`</p>
</li>
<li>
<p>Verify your changes by looking for a new pods in <code>userN-dev</code>
namespace.</p>
</li>
<li>
<p>When you are happy with the behavior of your integrations in the dev
namespace, create a new branch based on dev
<code>$ git checkout -b feature/my-first-prod-release origin/dev</code></p>
</li>
<li>
<p>Modify <code>lab5/charts/prod/values.yaml</code> only. Copy bindings from <code>dev</code>
environment but change destination name and userNamespace to point to
<code>prod</code> namespace.</p>
</li>
<li>
<p>Commit and push your changes</p>
</li>
<li>
<p>Create a pull request from <code>feature/my-first-prod-release</code> to <code>main</code>
branch. Review and approve the pull request.</p>
</li>
<li>
<p>Verify that the bindings are correctly created in <code>userN-prod</code>
namespace - which is the namespace used by Argo application monitoring
the <code>main</code> branch.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h3>
<div class="paragraph">
<p>In this chapter we showed how can we use Helm and ArgoCD to effectively
deploy and promote our integration.</p>
</div>
<div class="paragraph">
<p>When using <code>camel-k</code>, the CRs used (Integrations, Kamelet Bindings)
fully represent the integration. There is no need for any intermediate
steps in form of compiling or building the integration. KameletBinding
<em>is</em> your integration.</p>
</div>
<div class="paragraph">
<p>Obviously, for more advanced use cases you’d want to combine the
approach from Lab 4 (CI) with the one in Lab5 (CD) to include testing
and automated promotion.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="lab4.html">4. Lab 4 - Traditional CI/CD</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
