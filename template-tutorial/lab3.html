<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Red Hat Tech Exchange 2023</title>
    <link rel="canonical" href="https://agiertli.github.io/rhte-camelk-lab-instructions/template-tutorial/index.html/template-tutorial/lab3.html">
    <link rel="prev" href="lab2.html">
    <link rel="next" href="lab4.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://agiertli.github.io/rhte-camelk-lab-instructions/template-tutorial/index.html">Red Hat Tech Exchange 2023</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="template-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="00-camelk-overview.html">(optional) camel-k crash course</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="01-setup.html">0. Setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab1.html">1. Lab 1 - Local Development</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab2.html">2. Lab 2 - Customizing Kamelets</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="lab3.html">3. Lab 3 - KameletBinding evolution</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab4.html">4. Lab 4 - Traditional CI/CD</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab5.html">5. Lab 5 - GitOps styled Continuous Delivery</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Template Tutorial</a></li>
    <li><a href="lab3.html">3. Lab 3 - KameletBinding evolution</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/agiertli/rhte-camelk-lab-instructions/edit/main/documentation/modules/ROOT/pages/lab3.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_lab_3_kameletbinding_evolution"><a class="anchor" href="#_lab_3_kameletbinding_evolution"></a>Lab 3 - KameletBinding evolution</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_intro"><a class="anchor" href="#_intro"></a>Intro</h3>
<div class="paragraph">
<p>So far we have been developing our integrations in Java. There are other
DSL out there (such as groovy, javascript, and even yaml) but
development of such Integrations is still a fairly technical task and it
requires camel knowledge. However with well designed (reusable,
configurable) <code>Kamelets</code> itâ€™s possible to deploy an integration using a
slightly different way - by utilizing <code>KameletBinding</code>.</p>
</div>
<div class="paragraph">
<p>As the name suggests, itâ€™s a OpenShift custom resource which allows you
to bind source/sink kamelets (or camel components) in a declarative way.
This opens new possibilities for camel-k. <strong>KameletBindings</strong> enable
non-camel experts to deploy and configure Integrations.</p>
</div>
<div class="paragraph">
<p>This doesnâ€™t mean usage of camel-k doesnâ€™t require deep technical and
integration knowledge - somebody <em>still</em> has to develop and maintain the
Kamelets, but once that is done, the adoption of <strong>KameletBindings</strong>
(especially when combined with a templating engine such as <code>helm</code>) will
be very straightfoward.</p>
</div>
<div class="paragraph">
<p>It has another advantage - the fact itâ€™s a OpenShift CR means we donâ€™t
have to deal with <code>kamel cli</code> anymore to run an integration. We can
directly apply the file on OpenShift and it will result into running
Integration. This also greatly fits into todayâ€™s GitOps ways of working.</p>
</div>
</div>
<div class="sect2">
<h3 id="_task"><a class="anchor" href="#_task"></a>Task</h3>
<div class="paragraph">
<p>In this lab we will: - Turn our Java based integration into a Kamelet
Binding. - Use <code>helm</code> to generate multiple Kamelet Bindings with ease. -
Generate N bindings (where N is number of lab users) to generate messages
for every user in this lab. - Add one more binding which will simply
read all the messages you as a user received.</p>
</div>
<div class="paragraph">
<p>The output of the helm chart should produce this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/helm-chart-design.svg" alt="Helm chart design for User1">
</div>
<div class="title">Figure 1. Helm Chart design for User1</div>
</div>
<div class="paragraph">
<p>The actual helm templates were already developed for you.</p>
</div>
<div class="paragraph">
<p>While helm and KameletBindings go really well together - because itâ€™s
really easy to template the bindings, Kamelets also heavily depend on
using <code>{{ camel-k-placeholders }}</code> which conflicts with
<code>{{ helm-placeholders }}</code>, so figuring out the syntax is a major PITA.</p>
</div>
<div class="paragraph">
<p><strong>1. Create Secrets</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Letâ€™s start by secret provisioning. If you finished previous lab, you
should already have secret containing <code>client.ts</code> available in
<code>userN-dev</code> namespace. If not, make sure to create it now, i.e.:</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project userN-dev &amp;&amp;
cd utils &amp;&amp;
oc create secret generic client-truststore --from-file=client.ts</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add one more secret - previously, our Java integration contained some
hardcoded values with sensitive information (such as broker
credentials). This is of course not feasible in beyond demo scenario!
Letâ€™s create <em>another</em> secret which will contain:</p>
<div class="ulist">
<ul>
<li>
<p>broker username (admin)</p>
</li>
<li>
<p>broker password (password1!)</p>
</li>
<li>
<p>broker connection url
(amqps://rhte-artemis-one-way-ssl-0-svc.tooling.svc.cluster.local:5673)</p>
</li>
<li>
<p>truststore password (password1!)</p>
<div class="paragraph">
<p><strong>You can use <code>utils/create-secrets.sh</code> and <code>utils/artemis-secret.yaml</code>
to assist with this task.</strong></p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">## Change the values in create-secrets.sh
 ./create-secrets.sh</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>2. Helm + Kamel = ðŸ’ª</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Explore <code>charts/templates</code> - thatâ€™s where all the magic happens. We
are defining a few custom Kamelets, but most importantly we are
templating the creation of Kamelet Bindings.</p>
<div class="ulist">
<ul>
<li>
<p>Understand how <em>binary</em> (vs <em>normal</em>) secrets are handled.</p>
</li>
<li>
<p>We are also using
<a href="https://camel.apache.org/camel-k/1.8.x/traits/traits.html">traits</a> which
is a camel-k feature which allows us to enable additional super powers
on top of our integrations. Usage of the <code>Container</code> trait is almost
inevitable in OCP environment.</p>
</li>
<li>
<p>If you study <code>kamelet-bindings.yaml</code> you will notice it is completely
generic and supports <em>any</em> two Kamelets and <em>any</em> properties.</p>
<div class="ulist">
<ul>
<li>
<p>This is a very powerful concept as you can use this as a base template
to define integrations for many different systems. However, if this was
a real-world scenario, this helm chart wouldnâ€™t be so useful without the
accompanying documentation. The only way how to make the consumption of
such helm chart easy, is to make sure its consumers can focus on just
supplying helm values, and not to deal with the underlying templates
(which are still fairly complex and technical).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Change <code>dev/values.yaml</code> in such a way that will create the
appropriate bindings as per the Helm Diagram screenshot. There are
scripts ready for you in <code>utils</code> to test the helm chart.</p>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete kamelet custom-jms-amqp-10-sink &amp;&amp;
./install.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result should look similar to this:</p>
</div>
</li>
</ul>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get klb -n userN-dev
NAME                           PHASE   REPLICAS
rhte-camelk.user1.to.user2   Ready   1
rhte-camelk.user1.to.user3   Ready   1
rhte-camelk.user1.to.user4   Ready   1
rhte-camelk.user1.to.user5   Ready   1
rhte-camelk.user1.to.user6   Ready   1
rhte-camelk.user1.to.user7   Ready   1
rhte-camelk.user1.to.log      Ready   1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The number of <code>userN.to.userM</code> bindings can differ based on the
number of actual users present in the lab. Donâ€™t forget to check the
integration logs to make sure there are no errors. You can use
<code>kamel get</code> and <code>kamel log</code>, or plain <code>oc</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h3>
<div class="paragraph">
<p>We showcased how <code>helm</code> can be easily used to generate KameletBindings.
This combination allow easier consumption of camel-k styled integration,
as all it requires is a documentation of <code>helm</code> value files. We also
showed how to inject configuration and sensitive data into the bindings
and also scratched the surface on the <code>traits</code>.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="lab2.html">2. Lab 2 - Customizing Kamelets</a></span>
  <span class="next"><a href="lab4.html">4. Lab 4 - Traditional CI/CD</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
